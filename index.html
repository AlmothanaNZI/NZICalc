<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Calculator - Step-by-Step Wizard</title>
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Background color tokens (Light Mode) */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);

            /* Semantic Color Tokens (Light Mode) */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

            /* Typography */
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;

            /* Spacing */
            --space-0: 0;
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

            /* Animation */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

            /* Custom colors for FOB/CIF */
            --color-fob: #2563eb;
            --color-fob-light: rgba(37, 99, 235, 0.1);
            --color-fob-border: rgba(37, 99, 235, 0.3);
            --color-cif: #16a34a;
            --color-cif-light: rgba(22, 163, 74, 0.1);
            --color-cif-border: rgba(22, 163, 74, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            line-height: var(--line-height-normal);
            color: var(--color-text);
            background-color: var(--color-background);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-16);
        }

        /* Wizard Layout */
        .wizard-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--space-32));
        }

        .wizard-progress {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            margin-bottom: var(--space-16);
            box-shadow: var(--shadow-sm);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-16);
            flex-wrap: wrap;
            gap: var(--space-8);
        }

        .step {
            display: flex;
            align-items: center;
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            transition: all var(--duration-fast) var(--ease-standard);
            cursor: pointer;
            min-width: 120px;
            justify-content: center;
        }

        .step.active {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .step.completed {
            background: var(--color-success);
            color: var(--color-white);
        }

        .step.inactive {
            background: var(--color-secondary);
            color: var(--color-text-secondary);
        }

        .wizard-content {
            flex: 1;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            box-shadow: var(--shadow-sm);
            overflow-y: auto;
        }

        .wizard-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-16);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            margin-top: var(--space-16);
            box-shadow: var(--shadow-sm);
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-32);
            padding: var(--space-24);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .header h1 {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-8);
        }

        .header p {
            font-size: var(--font-size-lg);
            color: var(--color-text-secondary);
        }

        .section {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-24);
            overflow: hidden;
        }

        .section-header {
            padding: var(--space-16) var(--space-24);
            background: var(--color-secondary);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
        }

        .section-header.fob {
            background: var(--color-fob-light);
            border-left: 4px solid var(--color-fob);
        }

        .section-header.cif {
            background: var(--color-cif-light);
            border-left: 4px solid var(--color-cif);
        }

        .section-content {
            padding: var(--space-24);
        }

        .section-content.collapsed {
            display: none;
        }

        .toggle-icon {
            transition: transform var(--duration-fast) var(--ease-standard);
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .form-label {
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
            color: var(--color-text);
            position: relative;
        }

        .form-label.required::after {
            content: '*';
            color: var(--color-error);
            margin-left: var(--space-4);
        }

        .form-control {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            background: var(--color-white);
            transition: border-color var(--duration-fast) var(--ease-standard);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }

        .form-control.error {
            border-color: var(--color-error);
        }

        .error-message {
            color: var(--color-error);
            font-size: var(--font-size-sm);
            margin-top: var(--space-4);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
            gap: var(--space-8);
        }

        .btn--primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn--secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn--sm {
            padding: var(--space-6) var(--space-12);
            font-size: var(--font-size-sm);
        }

        .btn--danger {
            background: var(--color-error);
            color: var(--color-white);
        }

        .btn--danger:hover {
            background: var(--color-red-400);
        }

        .table-container {
            overflow-x: auto;
            margin: var(--space-16) 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .data-table th,
        .data-table td {
            padding: var(--space-8) var(--space-12);
            text-align: left;
            border: 1px solid var(--color-border);
        }

        .data-table th {
            background: var(--color-secondary);
            font-weight: var(--font-weight-semibold);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th.fob {
            background: var(--color-fob-light);
            color: var(--color-fob);
        }

        .data-table th.cif {
            background: var(--color-cif-light);
            color: var(--color-cif);
        }

        .data-table input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: var(--font-size-sm);
            padding: var(--space-4);
        }

        .data-table input:focus {
            outline: 1px solid var(--color-primary);
            border-radius: var(--radius-sm);
        }

        .data-table .calculated {
            background: var(--color-gray-200);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }
        
        #unified-costs-table {
            font-size: var(--font-size-xs);
        }
        
        #unified-costs-table th {
            text-align: center;
            white-space: nowrap;
            padding: var(--space-6) var(--space-8);
        }
        
        #unified-costs-table td {
            text-align: center;
            padding: var(--space-4) var(--space-6);
        }
        
        #unified-costs-table input {
            text-align: center;
            font-size: var(--font-size-xs);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-16);
            flex-wrap: wrap;
            gap: var(--space-12);
        }

        .toolbar-group {
            display: flex;
            gap: var(--space-8);
            align-items: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-secondary);
            border-radius: var(--radius-full);
            margin-bottom: var(--space-16);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: var(--radius-full);
            transition: width var(--duration-normal) var(--ease-standard);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin: var(--space-24) 0;
        }

        .summary-card {
            background: var(--color-surface);
            padding: var(--space-16);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .summary-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-8);
        }

        .summary-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--color-text-secondary);
            margin-left: var(--space-4);
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-charcoal-800);
            color: var(--color-white);
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--duration-fast) var(--ease-standard);
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .alert {
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .alert--warning {
            background: rgba(var(--color-warning-rgb), 0.1);
            border: 1px solid var(--color-warning);
            color: var(--color-warning);
        }

        .alert--success {
            background: rgba(var(--color-success-rgb), 0.1);
            border: 1px solid var(--color-success);
            color: var(--color-success);
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-8);
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-group {
                justify-content: center;
            }
        }

        @media print {
            .toolbar,
            .btn,
            .section-header {
                display: none !important;
            }

            .section-content {
                display: block !important;
            }

            body {
                background: white;
            }
        }

        .hidden {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-16 {
            margin-bottom: var(--space-16);
        }

        .mb-24 {
            margin-bottom: var(--space-24);
        }

        .mt-16 {
            margin-top: var(--space-16);
        }

        .flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .gap-8 {
            gap: var(--space-8);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Shipping Calculator - Step-by-Step Wizard</h1>
            <p>Professional shipping cost calculation with improved user experience</p>
            <div style="margin-top: var(--space-16); display: flex; gap: var(--space-8); justify-content: center; flex-wrap: wrap;">
                <button class="btn btn--primary" onclick="loadSampleData()">🧪 Test with Sample Data</button>
                <button class="btn btn--secondary" onclick="startNew()">🆕 Start New</button>
                <button class="btn btn--secondary" onclick="exportResults()">📄 Export PDF</button>
            </div>
        </div>

        <div class="wizard-container">
            <div class="wizard-progress">
                <div class="progress-steps">
                    <div class="step active" data-step="1" onclick="goToStep(1)">
                        <span>1. Setup</span>
                    </div>
                    <div class="step inactive" data-step="2" onclick="goToStep(2)">
                        <span>2. Products</span>
                    </div>
                    <div class="step inactive" data-step="3" onclick="goToStep(3)">
                        <span>3. Quantities</span>
                    </div>
                    <div class="step inactive" data-step="4" onclick="goToStep(4)">
                        <span>4. Added Costs, HS Code &amp; Tariffs</span>
                    </div>
                    <div class="step inactive" data-step="5" onclick="goToStep(5)">
                        <span>5. Review</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 20%"></div>
                </div>
            </div>

            <div class="wizard-content">
                <!-- STEP 1: QUOTATION SETUP -->
                <div class="step-content active" id="step-1">
                    <h2 style="margin-bottom: var(--space-24);">Step 1: Quotation Setup</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Customer Name</label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Country</label>
                            <input type="text" class="form-control" id="customer-country">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendor Name</label>
                            <input type="text" class="form-control" id="vendor-name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendor Country</label>
                            <input type="text" class="form-control" id="vendor-country">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shipping Term</label>
                            <select class="form-control" id="shipping-term">
                                <option value="">Select Term</option>
                                <option value="FOB">FOB - Free on Board</option>
                                <option value="CIF">CIF - Cost, Insurance, Freight</option>
                                <option value="EXW">EXW - Ex Works</option>
                                <option value="DDP">DDP - Delivered Duty Paid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expected Month</label>
                            <input type="month" class="form-control" id="expected-month">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transit Time (Days)</label>
                            <input type="number" class="form-control" id="transit-time" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Production Time (Days)</label>
                            <input type="number" class="form-control" id="production-time" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Terms</label>
                            <input type="text" class="form-control" id="payment-terms">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Container Capacity %</label>
                            <input type="number" class="form-control" id="capacity-percentage" value="100" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">OSO % (Overhead, Sourcing, Operations)</label>
                            <input type="number" class="form-control" id="oso-percentage" value="15" min="0" max="99.99" step="0.01" required>
                            <div class="error-message" id="oso-error"></div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: PRODUCT ENTRY -->
                <div class="step-content" id="step-2">
                    <h2 style="margin-bottom: var(--space-24);">Step 2: Product Entry (Max 8 Products)</h2>
                    
                    <div style="margin-bottom: var(--space-16); display: flex; gap: var(--space-8); flex-wrap: wrap;">
                        <button class="btn btn--primary btn--sm" onclick="addProductCard()">➕ Add Product</button>
                        <span style="align-self: center;">Products: <span id="product-count">0</span>/8</span>
                    </div>
                    
                    <div id="products-container" style="display: grid; gap: var(--space-16);">
                        <!-- Product cards will be inserted here -->
                    </div>
                </div>

                <!-- STEP 3: CONTAINER QUANTITIES -->
                <div class="step-content" id="step-3">
                    <h2 style="margin-bottom: var(--space-24);">Step 3: Container Quantities</h2>
                    
                    <div class="table-container">
                        <table class="data-table" id="quantities-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>20' Qty</th>
                                    <th>40' Qty</th>
                                    <th>40'HC Qty</th>
                                    <th>45'HC Qty</th>
                                    <th>53' Qty</th>
                                    <th>FOB Total</th>
                                    <th>CIF Total</th>
                                </tr>
                            </thead>
                            <tbody id="quantities-tbody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="summary-grid" style="margin-top: var(--space-24);">
                        <div class="summary-card">
                            <div class="summary-value" id="total-containers">0</div>
                            <div class="summary-label">Total Containers</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="total-fob-value">$0</div>
                            <div class="summary-label">Total FOB Value</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="total-cif-value">$0</div>
                            <div class="summary-label">Total CIF Value</div>
                        </div>
                    </div>
                </div>

                <!-- STEP 4: ADDED COSTS, HS CODE & TARIFFS -->
                <div class="step-content" id="step-4">
                    <h2 style="margin-bottom: var(--space-24);">Step 4: Added Costs, HS Code &amp; Tariffs</h2>
                    
                    <div class="form-grid" style="margin-bottom: var(--space-24);">
                        <div class="form-group">
                            <label class="form-label">HS CODE Number</label>
                            <input type="text" class="form-control" id="hs-code" placeholder="e.g., 8471.30.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">HS CODE Percentage (%)</label>
                            <input type="number" class="form-control" id="hs-percentage" min="0" max="100" step="0.01" placeholder="e.g., 5">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table" id="unified-costs-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Container Type</th>
                                    <th colspan="6" class="fob">FOB Costs</th>
                                    <th colspan="6" class="cif">CIF Costs</th>
                                </tr>
                                <tr>
                                    <th class="fob">Container Value</th>
                                    <th class="fob">HS Code %</th>
                                    <th class="fob">HS Charge</th>
                                    <th class="fob">Tariffs</th>
                                    <th class="fob">Inland</th>
                                    <th class="fob">Others</th>
                                    <th class="cif">Container Value</th>
                                    <th class="cif">HS Code %</th>
                                    <th class="cif">HS Charge</th>
                                    <th class="cif">Tariffs</th>
                                    <th class="cif">Inland</th>
                                    <th class="cif">Others</th>
                                </tr>
                            </thead>
                            <tbody id="unified-costs-tbody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- STEP 5: REVIEW & RESULTS -->
                <div class="step-content" id="step-5">
                    <h2 style="margin-bottom: var(--space-24);">Step 5: Review &amp; Results</h2>
                    
                    <div class="summary-grid" style="margin-bottom: var(--space-24);">
                        <div class="summary-card">
                            <div class="summary-value" id="final-products">0</div>
                            <div class="summary-label">Total Products</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="final-containers">0</div>
                            <div class="summary-label">Total Containers</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="final-fob-total">$0</div>
                            <div class="summary-label">Total FOB Value</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="final-cif-total">$0</div>
                            <div class="summary-label">Total CIF Value</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-24);">
                        <div>
                            <h3 style="color: var(--color-fob);">FOB Landed Costs Summary</h3>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Base UOM</th>
                                            <th>Landed UOM</th>
                                            <th>Landed Each</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fob-summary-tbody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="color: var(--color-cif);">CIF Landed Costs Summary</h3>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Base UOM</th>
                                            <th>Landed UOM</th>
                                            <th>Landed Each</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cif-summary-tbody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wizard-navigation">
                <button class="btn btn--secondary" id="back-btn" onclick="previousStep()" disabled>
                    ← Back
                </button>
                
                <div style="display: flex; gap: var(--space-8);">
                    <span id="validation-status"></span>
                </div>
                
                <button class="btn btn--primary" id="next-btn" onclick="nextStep()">
                    Next →
                </button>
            </div>
        </div>



        <!-- Verification Panel (Hidden by default) -->
        <div class="section hidden" id="verification-panel">
            <div class="section-header" style="background: var(--color-success); color: white;">
                <h2>✅ Test Data Verification Results</h2>
                <button class="btn btn--sm" style="background: white; color: var(--color-success);" onclick="hideVerification()">Close</button>
            </div>
            <div class="section-content">
                <div id="verification-results"></div>
            </div>
        </div>















    </div>

    <script>
        // Constants
        const CONTAINER_CONSTANTS = {
            '20': 1172,
            '40': 2366,
            '40HC': 2694,
            '45HC': 3040,
            '53': 3830
        };

        const CONTAINER_TYPES = ['20', '40', '40HC', '45HC', '53'];
        const MAX_PRODUCTS = 8;
        
        // Sample test data
        const SAMPLE_DATA = {
            setup: {
                customerName: "ABC Import Co.",
                customerCountry: "USA",
                vendorName: "XYZ Manufacturing",
                vendorCountry: "China",
                shippingTerm: "FOB",
                expectedMonth: "2024-11",
                transitTime: 30,
                productionTime: 45,
                paymentTerms: "30% deposit, 70% on shipment",
                capacityPercent: 100,
                osoPercent: 15
            },
            products: [
                {
                    description: "Widget Pro 3000",
                    brand: "ProBrand",
                    pack: 12,
                    size: "Large",
                    cbf: 2.5,
                    weight: 25,
                    fobInitialCost: 10.00,
                    cifInitialCost: 12.50,
                    expectedFobWithOSO: 11.76,
                    expectedFobEach: 0.98,
                    expectedCifWithOSO: 14.71,
                    expectedCifEach: 1.23
                },
                {
                    description: "Super Gadget",
                    brand: "MegaCorp",
                    pack: 24,
                    size: "Medium",
                    cbf: 1.8,
                    weight: 18,
                    fobInitialCost: 8.50,
                    cifInitialCost: 10.00,
                    expectedFobWithOSO: 10.00,
                    expectedFobEach: 0.42,
                    expectedCifWithOSO: 11.76,
                    expectedCifEach: 0.49
                }
            ],
            quantities: {
                product1: { '20': 2, '40': 1, '40HC': 0, '45HC': 0, '53': 0 },
                product2: { '20': 0, '40': 0, '40HC': 1, '45HC': 0, '53': 0 }
            },
            addedCosts: {
                '20': { hsCodeFob: 100, tariffsFob: 150, inlandFob: 200, othersFob: 50,
                       hsCodeCif: 120, tariffsCif: 180, inlandCif: 220, othersCif: 60 },
                '40': { hsCodeFob: 200, tariffsFob: 300, inlandFob: 400, othersFob: 100,
                       hsCodeCif: 220, tariffsCif: 330, inlandCif: 420, othersCif: 110 },
                '40HC': { hsCodeFob: 250, tariffsFob: 350, inlandFob: 450, othersFob: 120,
                         hsCodeCif: 270, tariffsCif: 380, inlandCif: 470, othersCif: 130 },
                '45HC': { hsCodeFob: 300, tariffsFob: 400, inlandFob: 500, othersFob: 150,
                         hsCodeCif: 320, tariffsCif: 430, inlandCif: 520, othersCif: 160 },
                '53': { hsCodeFob: 350, tariffsFob: 450, inlandFob: 550, othersFob: 180,
                       hsCodeCif: 370, tariffsCif: 480, inlandCif: 570, othersCif: 190 }
            },
            hsCode: {
                code: "8471.30.01",
                percent: 5
            }
        };

        // Global state
        let currentStep = 1;
        let products = [];
        let quantities = {};
        let addedCosts = {
            fob: {
                '20': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '40': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '40HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '45HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '53': { hsCode: 0, tariffs: 0, inland: 0, others: 0 }
            },
            cif: {
                '20': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '40': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '40HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '45HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                '53': { hsCode: 0, tariffs: 0, inland: 0, others: 0 }
            }
        };
        let hsData = { code: '', percent: 0 };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeWizard();
            updateStepDisplay();
            setupEventListeners();
        });

        function initializeWizard() {
            updateUnifiedCostsTable();
            updateAllTables();
        }

        function setupEventListeners() {
            // Real-time calculation triggers
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', debounce(() => {
                    calculateAll();
                    updateValidationStatus();
                }, 300));
            });

            // OSO percentage validation
            document.getElementById('oso-percentage').addEventListener('input', function() {
                validateOSOPercentage();
                calculateAll();
            });
            
            // HS Code inputs
            document.getElementById('hs-code').addEventListener('input', function() {
                hsData.code = this.value;
                calculateAll();
            });
            
            document.getElementById('hs-percentage').addEventListener('input', function() {
                hsData.percent = parseFloat(this.value) || 0;
                updateHSPercentage(this.value);
            });
        }
        
        // Wizard Navigation Functions
        function goToStep(stepNumber) {
            if (stepNumber < 1 || stepNumber > 5) return;
            if (stepNumber > currentStep + 1 && !canAdvanceToStep(stepNumber)) return;
            
            currentStep = stepNumber;
            updateStepDisplay();
            updateAllTables();
        }
        
        function nextStep() {
            if (validateCurrentStep() && currentStep < 5) {
                currentStep++;
                updateStepDisplay();
                updateAllTables();
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }
        
        function updateStepDisplay() {
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed', 'inactive');
                
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else {
                    step.classList.add('inactive');
                }
            });
            
            // Update content display
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                }
            });
            
            // Update navigation buttons
            document.getElementById('back-btn').disabled = currentStep === 1;
            const nextBtn = document.getElementById('next-btn');
            if (currentStep === 5) {
                nextBtn.textContent = '✅ Complete';
                nextBtn.onclick = completeWizard;
            } else {
                nextBtn.textContent = 'Next →';
                nextBtn.onclick = nextStep;
            }
            
            // Update progress bar
            const progress = (currentStep / 5) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }
        
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return validateStep1();
                case 2:
                    return validateStep2();
                case 3:
                case 4:
                case 5:
                    return true; // Optional steps
                default:
                    return true;
            }
        }
        
        function validateStep1() {
            const customerName = document.getElementById('customer-name').value.trim();
            const osoValid = validateOSOPercentage();
            
            if (!customerName) {
                document.getElementById('customer-name').classList.add('error');
                updateValidationStatus('❌ Customer name is required');
                return false;
            }
            
            document.getElementById('customer-name').classList.remove('error');
            
            if (!osoValid) {
                updateValidationStatus('❌ Valid OSO percentage required');
                return false;
            }
            
            updateValidationStatus('✅ Step valid');
            return true;
        }
        
        function validateStep2() {
            if (products.length === 0) {
                updateValidationStatus('❌ At least one product required');
                return false;
            }
            
            let hasValidProduct = false;
            for (let product of products) {
                if (product.description.trim() && (product.fobInitialCost > 0 || product.cifInitialCost > 0)) {
                    hasValidProduct = true;
                    break;
                }
            }
            
            if (!hasValidProduct) {
                updateValidationStatus('❌ At least one product must have description and cost');
                return false;
            }
            
            updateValidationStatus('✅ Step valid');
            return true;
        }
        
        function updateValidationStatus(message) {
            document.getElementById('validation-status').textContent = message;
        }
        
        function canAdvanceToStep(stepNumber) {
            for (let i = 1; i < stepNumber; i++) {
                const prevStep = currentStep;
                currentStep = i;
                if (!validateCurrentStep()) {
                    currentStep = prevStep;
                    return false;
                }
            }
            currentStep = stepNumber - 1; // Reset to allow normal advance
            return true;
        }
        
        function completeWizard() {
            alert('Quotation completed! You can now export the results.');
        }
        
        function validateOSOPercentage() {
            const osoInput = document.getElementById('oso-percentage');
            const errorDiv = document.getElementById('oso-error');
            const osoValue = parseFloat(osoInput.value) || 0;
            
            if (osoValue >= 100) {
                osoInput.classList.add('error');
                errorDiv.textContent = 'OSO % must be less than 100%';
                return false;
            } else if (osoValue < 0) {
                osoInput.classList.add('error');
                errorDiv.textContent = 'OSO % cannot be negative';
                return false;
            } else {
                osoInput.classList.remove('error');
                errorDiv.textContent = '';
                return true;
            }
        }

        // Sample Data Loading & Testing
        function loadSampleData() {
            if (!confirm('Load sample test data? This will replace current data.')) return;
            
            // Load setup data
            const setup = SAMPLE_DATA.setup;
            document.getElementById('customer-name').value = setup.customerName;
            document.getElementById('customer-country').value = setup.customerCountry;
            document.getElementById('vendor-name').value = setup.vendorName;
            document.getElementById('vendor-country').value = setup.vendorCountry;
            document.getElementById('shipping-term').value = setup.shippingTerm;
            document.getElementById('expected-month').value = setup.expectedMonth;
            document.getElementById('transit-time').value = setup.transitTime;
            document.getElementById('production-time').value = setup.productionTime;
            document.getElementById('payment-terms').value = setup.paymentTerms;
            document.getElementById('capacity-percentage').value = setup.capacityPercent;
            document.getElementById('oso-percentage').value = setup.osoPercent;
            
            // Load products
            products = [];
            SAMPLE_DATA.products.forEach((productData, index) => {
                const product = {
                    id: `product_${Date.now()}_${index}`,
                    description: productData.description,
                    brand: productData.brand,
                    pack: productData.pack,
                    size: productData.size,
                    cbf: productData.cbf,
                    weight: productData.weight,
                    fobInitialCost: productData.fobInitialCost,
                    cifInitialCost: productData.cifInitialCost
                };
                products.push(product);
            });
            
            // Load quantities
            quantities = {};
            products.forEach((product, index) => {
                const key = `product${index + 1}`;
                if (SAMPLE_DATA.quantities[key]) {
                    quantities[product.id] = SAMPLE_DATA.quantities[key];
                }
            });
            
            // Load added costs - HS Code costs will be calculated automatically
            Object.keys(SAMPLE_DATA.addedCosts).forEach(containerType => {
                const costs = SAMPLE_DATA.addedCosts[containerType];
                addedCosts.fob[containerType] = {
                    hsCode: 0, // Will be calculated from percentage
                    tariffs: costs.tariffsFob,
                    inland: costs.inlandFob,
                    others: costs.othersFob
                };
                addedCosts.cif[containerType] = {
                    hsCode: 0, // Will be calculated from percentage
                    tariffs: costs.tariffsCif,
                    inland: costs.inlandCif,
                    others: costs.othersCif
                };
            });
            
            // Load HS Code data
            hsData = SAMPLE_DATA.hsCode;
            document.getElementById('hs-code').value = hsData.code;
            document.getElementById('hs-percentage').value = hsData.percent;
            
            // Calculate HS charges based on the loaded percentage
            updateHSPercentage(hsData.percent);
            
            calculateAll();
            updateAllTables();
            
            // Show verification
            runVerification();
        }
        
        function runVerification() {
            let results = '<h3>🧪 Calculation Verification Results</h3><div style="font-family: var(--font-family-mono); font-size: var(--font-size-sm);">';
            
            // Test 1: OSO Calculation
            const product1 = products[0];
            if (product1) {
                const osoPercent = 15;
                const fobInitial = 10;
                const expectedFOBWithOSO = fobInitial / (1 - (osoPercent / 100));
                const actualFOBWithOSO = calculateCostWithOSO(product1.fobInitialCost);
                
                results += `<p><strong>Test 1 - OSO Markup:</strong><br>`;
                results += `Formula: $${fobInitial} ÷ (1 - 0.15) = $${fobInitial} ÷ 0.85 = $${expectedFOBWithOSO.toFixed(2)}<br>`;
                results += `Expected: $${expectedFOBWithOSO.toFixed(2)} | Actual: $${actualFOBWithOSO.toFixed(2)} | `;
                results += `${Math.abs(expectedFOBWithOSO - actualFOBWithOSO) < 0.01 ? '✅ PASS' : '❌ FAIL'}</p>`;
                
                // Test 2: Pack Division
                const expectedEach = expectedFOBWithOSO / product1.pack;
                const actualEach = calculateFOBEachPrice(product1);
                
                results += `<p><strong>Test 2 - Pack Division:</strong><br>`;
                results += `Formula: $${expectedFOBWithOSO.toFixed(2)} ÷ ${product1.pack} = $${expectedEach.toFixed(2)}<br>`;
                results += `Expected: $${expectedEach.toFixed(2)} | Actual: $${actualEach.toFixed(2)} | `;
                results += `${Math.abs(expectedEach - actualEach) < 0.01 ? '✅ PASS' : '❌ FAIL'}</p>`;
                
                // Test 3: Container Cost
                if (quantities[product1.id] && quantities[product1.id]['20']) {
                    const qty = quantities[product1.id]['20'];
                    const expectedContainerCost = qty * expectedFOBWithOSO;
                    const actualContainerCost = calculateContainerCost(product1, '20', qty, 'fob');
                    
                    results += `<p><strong>Test 3 - Container Cost:</strong><br>`;
                    results += `Formula: ${qty} × $${expectedFOBWithOSO.toFixed(2)} = $${expectedContainerCost.toFixed(2)}<br>`;
                    results += `Expected: $${expectedContainerCost.toFixed(2)} | Actual: $${actualContainerCost.toFixed(2)} | `;
                    results += `${Math.abs(expectedContainerCost - actualContainerCost) < 0.01 ? '✅ PASS' : '❌ FAIL'}</p>`;
                }
                
                // Test 4: HS Code Charge
                const totalValue = calculateTotalProductValue(product1, 'fob');
                const expectedHSCharge = totalValue * (hsData.percent / 100);
                const actualHSCharge = calculateProductHSCharge(product1, 'fob');
                
                results += `<p><strong>Test 4 - HS Code Charge:</strong><br>`;
                results += `Formula: $${totalValue.toFixed(2)} × ${hsData.percent}% = $${expectedHSCharge.toFixed(2)}<br>`;
                results += `Expected: $${expectedHSCharge.toFixed(2)} | Actual: $${actualHSCharge.toFixed(2)} | `;
                results += `${Math.abs(expectedHSCharge - actualHSCharge) < 0.01 ? '✅ PASS' : '❌ FAIL'}</p>`;
            }
            
            results += '</div>';
            
            document.getElementById('verification-results').innerHTML = results;
            document.getElementById('verification-panel').classList.remove('hidden');
            
            // Scroll to verification panel
            document.getElementById('verification-panel').scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideVerification() {
            document.getElementById('verification-panel').classList.add('hidden');
        }
        
        function updateUnifiedCostsTable() {
            const tbody = document.getElementById('unified-costs-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            CONTAINER_TYPES.forEach(containerType => {
                const fobCosts = addedCosts.fob[containerType];
                const cifCosts = addedCosts.cif[containerType];
                
                // Calculate container values for this container type
                const fobContainerValue = calculateContainerValueForType(containerType, 'fob');
                const cifContainerValue = calculateContainerValueForType(containerType, 'cif');
                
                // Calculate HS charges - use stored values that get updated automatically
                const hsPercent = parseFloat(document.getElementById('hs-percentage').value) || 0;
                const fobHSCharge = addedCosts.fob[containerType].hsCode;
                const cifHSCharge = addedCosts.cif[containerType].hsCode;
                
                const row = document.createElement('tr');
                // Only show editable HS percentage in first row, others show calculated value
                const isFirstRow = containerType === '20';
                
                row.innerHTML = `
                    <td><strong>${containerType}'</strong></td>
                    <td class="calculated">$${fobContainerValue.toFixed(2)}</td>
                    <td>${isFirstRow ? `<input type="number" value="${hsPercent}" min="0" max="100" step="0.01" onchange="updateHSPercentage(this.value)" style="width: 80px;">%` : `<span class="calculated">${hsPercent}%</span>`}</td>
                    <td class="calculated">$${fobHSCharge.toFixed(2)}</td>
                    <td><input type="number" value="${fobCosts.tariffs}" min="0" step="0.01" onchange="updateAddedCost('fob', '${containerType}', 'tariffs', parseFloat(this.value) || 0)" style="width: 100px;"></td>
                    <td><input type="number" value="${fobCosts.inland}" min="0" step="0.01" onchange="updateAddedCost('fob', '${containerType}', 'inland', parseFloat(this.value) || 0)" style="width: 100px;"></td>
                    <td><input type="number" value="${fobCosts.others}" min="0" step="0.01" onchange="updateAddedCost('fob', '${containerType}', 'others', parseFloat(this.value) || 0)" style="width: 100px;"></td>
                    <td class="calculated">$${cifContainerValue.toFixed(2)}</td>
                    <td class="calculated">${hsPercent}%</td>
                    <td class="calculated">$${cifHSCharge.toFixed(2)}</td>
                    <td><input type="number" value="${cifCosts.tariffs}" min="0" step="0.01" onchange="updateAddedCost('cif', '${containerType}', 'tariffs', parseFloat(this.value) || 0)" style="width: 100px;"></td>
                    <td><input type="number" value="${cifCosts.inland}" min="0" step="0.01" onchange="updateAddedCost('cif', '${containerType}', 'inland', parseFloat(this.value) || 0)" style="width: 100px;"></td>
                    <td><input type="number" value="${cifCosts.others}" min="0" step="0.01" onchange="updateAddedCost('cif', '${containerType}', 'others', parseFloat(this.value) || 0)" style="width: 100px;"></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function calculateContainerValueForType(containerType, type) {
            let totalValue = 0;
            products.forEach(product => {
                const productQty = quantities[product.id] || {};
                const qty = productQty[containerType] || 0;
                if (qty > 0) {
                    totalValue += calculateContainerCost(product, containerType, qty, type);
                }
            });
            return totalValue;
        }
        
        function updateHSPercentage(value) {
            const hsPercent = parseFloat(value) || 0;
            document.getElementById('hs-percentage').value = hsPercent;
            hsData.percent = hsPercent;
            
            // Update HS Code charges for all container types based on the new percentage
            CONTAINER_TYPES.forEach(containerType => {
                const fobContainerValue = calculateContainerValueForType(containerType, 'fob');
                const cifContainerValue = calculateContainerValueForType(containerType, 'cif');
                
                addedCosts.fob[containerType].hsCode = (hsPercent / 100) * fobContainerValue;
                addedCosts.cif[containerType].hsCode = (hsPercent / 100) * cifContainerValue;
            });
            
            // Update all HS Code percentage fields in the table and recalculate
            calculateAll();
            updateUnifiedCostsTable();
            updateAllTables();
        }

        function updateAddedCost(type, containerType, costType, value) {
            addedCosts[type][containerType][costType] = value;
            calculateAll();
            updateAllTables();
        }

        // Product Management Functions
        function addProductCard() {
            if (products.length >= MAX_PRODUCTS) {
                alert(`Maximum ${MAX_PRODUCTS} products allowed`);
                return;
            }
            
            const product = {
                id: `product_${Date.now()}`,
                description: '',
                brand: '',
                pack: 1,
                size: '',
                cbf: 0,
                weight: 0,
                fobInitialCost: 0,
                cifInitialCost: 0
            };
            
            products.push(product);
            quantities[product.id] = { '20': 0, '40': 0, '40HC': 0, '45HC': 0, '53': 0 };
            
            updateProductsDisplay();
            updateProductCount();
        }
        
        function removeProduct(productId) {
            products = products.filter(p => p.id !== productId);
            delete quantities[productId];
            updateProductsDisplay();
            updateProductCount();
            calculateAll();
        }
        
        function updateProductsDisplay() {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            
            products.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.padding = 'var(--space-16)';
                
                const fobWithOSO = calculateCostWithOSO(product.fobInitialCost);
                const fobEach = product.pack > 0 ? fobWithOSO / product.pack : 0;
                const cifWithOSO = calculateCostWithOSO(product.cifInitialCost);
                const cifEach = product.pack > 0 ? cifWithOSO / product.pack : 0;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-16);">
                        <h4>Product ${index + 1}</h4>
                        <button class="btn btn--danger btn--sm" onclick="removeProduct('${product.id}')">🗑️ Remove</button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" value="${product.description}" onchange="updateProductField('${product.id}', 'description', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Brand</label>
                            <input type="text" class="form-control" value="${product.brand}" onchange="updateProductField('${product.id}', 'brand', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pack Size</label>
                            <input type="number" class="form-control" value="${product.pack}" min="1" onchange="updateProductField('${product.id}', 'pack', parseInt(this.value) || 1)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Size</label>
                            <input type="text" class="form-control" value="${product.size}" onchange="updateProductField('${product.id}', 'size', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CBF</label>
                            <input type="number" class="form-control" value="${product.cbf}" min="0" step="0.01" onchange="updateProductField('${product.id}', 'cbf', parseFloat(this.value) || 0)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Weight (lbs)</label>
                            <input type="number" class="form-control" value="${product.weight}" min="0" step="0.01" onchange="updateProductField('${product.id}', 'weight', parseFloat(this.value) || 0)">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-16); margin-top: var(--space-16);">
                        <div style="border: 2px solid var(--color-fob); border-radius: var(--radius-base); padding: var(--space-12);">
                            <h5 style="color: var(--color-fob); margin-bottom: var(--space-8);">FOB Costs</h5>
                            <div class="form-group">
                                <label class="form-label">Initial Cost ($)</label>
                                <input type="number" class="form-control" value="${product.fobInitialCost}" min="0" step="0.01" onchange="updateProductField('${product.id}', 'fobInitialCost', parseFloat(this.value) || 0)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cost with OSO ($)</label>
                                <input type="text" class="form-control calculated" value="$${fobWithOSO.toFixed(2)}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">UOM Price ($)</label>
                                <input type="text" class="form-control calculated" value="$${fobWithOSO.toFixed(2)}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Each Price ($)</label>
                                <input type="text" class="form-control calculated" value="$${fobEach.toFixed(2)}" readonly>
                            </div>
                        </div>
                        
                        <div style="border: 2px solid var(--color-cif); border-radius: var(--radius-base); padding: var(--space-12);">
                            <h5 style="color: var(--color-cif); margin-bottom: var(--space-8);">CIF Costs</h5>
                            <div class="form-group">
                                <label class="form-label">Initial Cost ($)</label>
                                <input type="number" class="form-control" value="${product.cifInitialCost}" min="0" step="0.01" onchange="updateProductField('${product.id}', 'cifInitialCost', parseFloat(this.value) || 0)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cost with OSO ($)</label>
                                <input type="text" class="form-control calculated" value="$${cifWithOSO.toFixed(2)}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">UOM Price ($)</label>
                                <input type="text" class="form-control calculated" value="$${cifWithOSO.toFixed(2)}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Each Price ($)</label>
                                <input type="text" class="form-control calculated" value="$${cifEach.toFixed(2)}" readonly>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function updateProductField(productId, field, value) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product[field] = value;
                calculateAll();
                updateProductsDisplay(); // Refresh to show new calculated values
                updateAllTables();
            }
        }
        
        function updateProductCount() {
            const countElement = document.getElementById('product-count');
            if (countElement) {
                countElement.textContent = products.length;
            }
        }

        // Update all tables when data changes
        function updateAllTables() {
            updateProductsDisplay();
            updateQuantitiesTable();
            updateUnifiedCostsTable();
            updateSummaryTables();
            updateTotals();
        }
        
        function updateQuantitiesTable() {
            const tbody = document.getElementById('quantities-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            products.forEach((product, index) => {
                const productQty = quantities[product.id] || {};
                const row = document.createElement('tr');
                
                let fobTotal = 0;
                let cifTotal = 0;
                
                CONTAINER_TYPES.forEach(containerType => {
                    const qty = productQty[containerType] || 0;
                    fobTotal += calculateContainerCost(product, containerType, qty, 'fob');
                    cifTotal += calculateContainerCost(product, containerType, qty, 'cif');
                });
                
                row.innerHTML = `
                    <td>${product.description || `Product ${index + 1}`}</td>
                    ${CONTAINER_TYPES.map(containerType => `
                        <td><input type="number" value="${productQty[containerType] || 0}" min="0" onchange="updateQuantity('${product.id}', '${containerType}', parseInt(this.value) || 0)"></td>
                    `).join('')}
                    <td class="calculated">$${fobTotal.toFixed(2)}</td>
                    <td class="calculated">$${cifTotal.toFixed(2)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateQuantity(productId, containerType, quantity) {
            if (!quantities[productId]) {
                quantities[productId] = {};
            }
            quantities[productId][containerType] = quantity;
            calculateAll();
            updateAllTables();
        }
        
        // HS Charges are now calculated and displayed in the unified costs table
        
        function updateSummaryTables() {
            updateSummaryTable('fob');
            updateSummaryTable('cif');
        }
        
        function updateSummaryTable(type) {
            const tbody = document.getElementById(`${type}-summary-tbody`);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            products.forEach((product, index) => {
                const baseUOM = type === 'fob' ? calculateFOBUOMPrice(product) : calculateCIFUOMPrice(product);
                const landedUOM = calculateAverageLandedUOM(product, type);
                const landedEach = product.pack > 0 ? landedUOM / product.pack : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.description || `Product ${index + 1}`}</td>
                    <td class="calculated">$${baseUOM.toFixed(2)}</td>
                    <td class="calculated">$${landedUOM.toFixed(2)}</td>
                    <td class="calculated">$${landedEach.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateTotals() {
            let totalContainers = 0;
            let totalFobValue = 0;
            let totalCifValue = 0;
            
            products.forEach(product => {
                const productQty = quantities[product.id] || {};
                Object.values(productQty).forEach(qty => {
                    totalContainers += qty;
                });
                
                totalFobValue += calculateTotalProductValue(product, 'fob');
                totalCifValue += calculateTotalProductValue(product, 'cif');
            });
            
            // Update Step 3 totals
            const totalContainersEl = document.getElementById('total-containers');
            const totalFobValueEl = document.getElementById('total-fob-value');
            const totalCifValueEl = document.getElementById('total-cif-value');
            
            if (totalContainersEl) totalContainersEl.textContent = totalContainers;
            if (totalFobValueEl) totalFobValueEl.textContent = `$${totalFobValue.toFixed(0)}`;
            if (totalCifValueEl) totalCifValueEl.textContent = `$${totalCifValue.toFixed(0)}`;
            
            // Update Step 6 totals
            const finalProductsEl = document.getElementById('final-products');
            const finalContainersEl = document.getElementById('final-containers');
            const finalFobTotalEl = document.getElementById('final-fob-total');
            const finalCifTotalEl = document.getElementById('final-cif-total');
            
            if (finalProductsEl) finalProductsEl.textContent = products.length;
            if (finalContainersEl) finalContainersEl.textContent = totalContainers;
            if (finalFobTotalEl) finalFobTotalEl.textContent = `$${totalFobValue.toLocaleString()}`;
            if (finalCifTotalEl) finalCifTotalEl.textContent = `$${totalCifValue.toLocaleString()}`;
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Utility Functions
        function startNew() {
            if (!confirm('Start a new quotation? All current data will be lost.')) return;
            
            // Reset all data
            products = [];
            quantities = {};
            addedCosts = {
                fob: {
                    '20': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '40': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '40HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '45HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '53': { hsCode: 0, tariffs: 0, inland: 0, others: 0 }
                },
                cif: {
                    '20': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '40': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '40HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '45HC': { hsCode: 0, tariffs: 0, inland: 0, others: 0 },
                    '53': { hsCode: 0, tariffs: 0, inland: 0, others: 0 }
                }
            };
            hsData = { code: '', percent: 0 };
            
            // Clear HS Code inputs
            document.getElementById('hs-code').value = '';
            document.getElementById('hs-percentage').value = '0';
            
            // Clear all form inputs
            document.querySelectorAll('input, select').forEach(input => {
                if (input.type === 'number') {
                    if (input.id === 'capacity-percentage') {
                        input.value = '100';
                    } else if (input.id === 'oso-percentage') {
                        input.value = '15';
                    } else {
                        input.value = '0';
                    }
                } else {
                    input.value = '';
                }
            });
            
            // Reset to step 1
            currentStep = 1;
            updateStepDisplay();
            updateAllTables();
            updateValidationStatus('Ready to start');
        }
        
        function exportResults() {
            window.print();
        }

































        // Core Calculation Functions
        function calculateCostWithOSO(initialCost) {
            const osoPercent = parseFloat(document.getElementById('oso-percentage').value) || 0;
            if (initialCost <= 0) return 0;
            if (osoPercent >= 100) return 0;
            return initialCost / (1 - (osoPercent / 100));
        }
        
        function calculateFOBUOMPrice(product) {
            return calculateCostWithOSO(product.fobInitialCost);
        }
        
        function calculateFOBEachPrice(product) {
            const uomPrice = calculateFOBUOMPrice(product);
            return product.pack > 0 ? uomPrice / product.pack : 0;
        }
        
        function calculateCIFUOMPrice(product) {
            return calculateCostWithOSO(product.cifInitialCost);
        }
        
        function calculateCIFEachPrice(product) {
            const uomPrice = calculateCIFUOMPrice(product);
            return product.pack > 0 ? uomPrice / product.pack : 0;
        }

        function calculateContainerCost(product, containerType, quantity, type = 'fob') {
            const uomPrice = type === 'fob' ? calculateFOBUOMPrice(product) : calculateCIFUOMPrice(product);
            const capacityPercent = parseFloat(document.getElementById('capacity-percentage').value) || 100;
            const actualCapacity = CONTAINER_CONSTANTS[containerType] * (capacityPercent / 100);
            return quantity * uomPrice * actualCapacity;
        }
        
        function calculateTotalProductValue(product, type) {
            const productQty = quantities[product.id] || {};
            let total = 0;
            
            CONTAINER_TYPES.forEach(containerType => {
                const qty = productQty[containerType] || 0;
                total += calculateContainerCost(product, containerType, qty, type);
            });
            
            return total;
        }
        
        function calculateProductHSCharge(product, type) {
            const totalValue = calculateTotalProductValue(product, type);
            return totalValue * (hsData.percent / 100);
        }
        
        function calculateTotalHSChargeForContainerType(containerType, type) {
            return addedCosts[type][containerType].hsCode;
        }
        

        
        function calculateAddedCostsPerUOM(containerType, type) {
            const costs = addedCosts[type][containerType];
            const totalCosts = costs.hsCode + costs.tariffs + costs.inland + costs.others;
            const totalQuantity = calculateTotalQuantityInContainer(containerType);
            return totalQuantity > 0 ? totalCosts / totalQuantity : 0;
        }
        
        function calculateTotalQuantityInContainer(containerType) {
            let total = 0;
            products.forEach(product => {
                const productQty = quantities[product.id] || {};
                total += productQty[containerType] || 0;
            });
            return total;
        }
        
        function calculateAverageLandedUOM(product, type) {
            let totalLanded = 0;
            let totalQuantity = 0;
            
            CONTAINER_TYPES.forEach(containerType => {
                const qty = quantities[product.id] ? quantities[product.id][containerType] || 0 : 0;
                if (qty > 0) {
                    totalLanded += calculateLandedUOM(product, containerType, type) * qty;
                    totalQuantity += qty;
                }
            });
            
            return totalQuantity > 0 ? totalLanded / totalQuantity : calculateLandedUOM(product, '20', type);
        }



        function calculateLandedUOM(product, containerType, type) {
            const basePrice = type === 'fob' ? calculateFOBUOMPrice(product) : calculateCIFUOMPrice(product);
            const addedCostsPerUOM = calculateAddedCostsPerUOM(containerType, type);
            return basePrice + addedCostsPerUOM;
        }





        function calculateAll() {
            // All calculations are done in real-time within the update functions
        }





        // Auto-save and session management (in-memory only for sandbox environment)
        let autoSaveData = null;
        
        function autoSave() {
            autoSaveData = {
                currentStep: currentStep,
                products: products,
                quantities: quantities,
                addedCosts: addedCosts,
                hsData: hsData,
                formData: getFormData(),
                timestamp: new Date().toISOString()
            };
        }
        
        function getFormData() {
            const formData = {};
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.id) {
                    formData[input.id] = input.value;
                }
            });
            return formData;
        }
        
        // Auto-save every 5 seconds
        setInterval(autoSave, 5000);
    </script>
</body>
</html>